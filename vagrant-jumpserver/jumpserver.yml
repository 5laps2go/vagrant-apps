---
- name: configure jump server to control vagrant/ansible master
  hosts: jump_servers
  become: true
  user: vagrant
  vars_files:
    - inventories/common/vars/securities.yml
  vars:
    github_repo: 5laps2go

  tasks:
    - name: install packages
      package:
        name: git,jq,gcc,wget,ansible,unzip
        state: present

    - name: setup vagrant yum repository
      get_url:
        url: https://rpm.releases.hashicorp.com/RHEL/hashicorp.repo
        dest: /etc/yum.repos.d/hashicorp.repo
        mode: '0644'
    - name: install vagrant
      yum:
        name: vagrant
        state: present
    - name: install vagrant plugin vmware-esxi
      ansible.builtin.command: vagrant plugin install vagrant-vmware-esxi
      become: yes
      become_user: vagrant
      args:
        creates: /home/vagrant/.vagrant.d/gems/3.3.8/gems/vagrant-vmware-esxi-2.5.5

    - name: Unarchive VMware-ovftool
      unarchive:
        src:  VMware-ovftool-5.0.0-24781994-lin.x86_64.zip
        dest: /usr/lib
    - name: ovftool command
      ansible.builtin.file:
        src: /usr/lib/ovftool/ovftool
        dest: /usr/bin/ovftool
        state: link
    - name: install libnsl package for ovftool
      package:
        name: libnsl
        state: present

    - name: enable ssh forwarding
      lineinfile:
        dest: /etc/ssh/sshd_config
        state: present
        regexp: '{{ item.regexp }}'
        line: '{{ item.line }}'
      with_items:
        - regexp: '^#?\s*AllowAgentForwarding'
          line: 'AllowAgentForwarding yes'
    - name: copy .ssh/config
      template:
        src: inventories/common/conf/ssh_config.j2
        dest: ~/.ssh/config
        mode: '0644'
      become: yes
      become_user: vagrant
    - name: add github ssh public key to vagrant user
      authorized_key:
        user: vagrant
        state: present
        key: https://github.com/{{ github_repo }}.keys
    - name: download ansible-galaxy role requirements
      copy:
        src: inventories/common/requirements.yml
        dest: /tmp
        mode: '0644'
      become: yes
      become_user: vagrant
    - name: install the ansible roles
      command: ansible-galaxy install -r /tmp/requirements.yml
      become: yes
      become_user: vagrant

    - name: prepare vagrant clone templates
      command: git clone git@github.com:5laps2go/vagrant-clone-templates.git
      args:
        creates: ./vagrant-clone-templates
      become: yes
      become_user: vagrant
    - name: prepare ESXI_PASSWD variable
      lineinfile:
        dest: /home/vagrant/.bashrc
        line: 'export ESXI_PASSWD=`cat ~/.vault_pass`'
    - name: install vagrant dummy_box
      command: vagrant box add --name esxi_clone/dummy ~/vagrant-clone-templates/dummybox/dummy.box
      become: yes
      become_user: vagrant
      args:
        creates: /home/vagrant/vagrant-clone-templates/dummybox/dummy.box

